<!DOCTYPE html>
<html>
<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=320,user-scalable=no">
    <style> * { margin:0; padding:0; } </style>
    <script src='lib/reversi.js'></script>
    </head>
<body> 
<canvas id="aCanvas" width="320" height="320"></canvas>
<div id="msg"></div>
<script type="text/javascript">

    var board = reversi.createBoard();
    reversi.putInitialPlace(board);

    // 描画の余白、1マスの幅、ボードの列数と行数
    var padX = 12, padY = 12;
    var cellW = 37;
    var bRows = 8, bCols = 8;
    var currentColor = 'black';
    
    var canvas = $("aCanvas");

    // イベントの設定
    canvas.ontouchstart = function (e) {
        var t = e.touches[0];
        e.preventDefault();
        touchHandler(t);
    };

    canvas.onmousedown = touchHandler;

    // コンテキストを取得
    var context = canvas.getContext("2d");

    drawBoard(canvas, currentColor, board);

    // ボードをタッチしたとき
    function touchHandler(t) {

        var x = t.pageX - padX;
        var y = t.pageY - padY;
        var cx = Math.floor(x / cellW);
        var cy = Math.floor(y / cellW);

        var index = cx + cy * bCols;

        var reversibleIndexes = reversi.findAllReversibleIndexes(index, currentColor, board);

        reversi.putPlace(index, currentColor, board); 
        reversi.reverseDisks(reversibleIndexes, currentColor, board);

        var parsed = parseBoard(currentColor, board);
        draw(canvas, parsed.blacks, parsed.whites, parsed.suggests);

        currentColor = currentColor === 'black' ? 'white' : 'black';

        $("msg").innerHTML = "コンピューターの番です。";
        
        setTimeout(function() {
                
            var npcPlacedIndex = reversi.npcPlay(currentColor, board);

            currentColor = currentColor === 'black' ? 'white' : 'black';
            
            drawBoard(canvas, currentColor, board);

            if(npcPlacedIndex) {
                $("msg").innerHTML = "あなたの番です。";
            }
            else {
                $("msg").innerHTML = "コンピュータはパスしました。あなたの番です。";
            } 
        }, 1000);
       
    }

    function parseBoard(color, board) {

        var blacks = [], whites = [];

        for (var i = 0, l = board.length; i < l; i++) {
            if (board[i] === 1) {
                blacks.push(i);
            }
            else if(board[i] === 2) {
                whites.push(i);
            }
        }

        var placeableIndexes = reversi.getRestPlaceableIndexes(color, board);

        return {blacks: blacks, whites: whites, suggests: placeableIndexes};
    }

    function drawBoard (canvas, currentColor, board) {
        
        var blacks = [], whites = [];

        for (var i = 0, l = board.length; i < l; i++) {
            if (board[i] === 1) {
                blacks.push(i);
            }
            else if(board[i] === 2) {
                whites.push(i);
            }
        }

        var suggests = reversi.getRestPlaceableIndexes(currentColor, board);

        draw(canvas, blacks, whites, suggests);
    }

    function draw(canvas, blacks, whites, suggests) {

        var context = canvas.getContext("2d");

        // 背景を初期化
        context.fillStyle = "green";
        context.fillRect(0, 0, 320, 320);

        // ボードのセル線を描画
        context.beginPath();

        var y1 = padY;
        var y2 = padY + bRows * cellW;
        
        for (var x = 0; x <= bCols; x++) {
            var xx = x * cellW + padX;
            context.moveTo(xx, y1);
            context.lineTo(xx, y2);
        }

        var x1 = padX;
        var x2 = padX + bCols * cellW;
        
        for (var y = 0; y <= bRows; y++) {
            var yy = y * cellW + padY;
            context.moveTo(x1, yy);
            context.lineTo(x2, yy);
        }
        
        context.strokeStyle = "white";
        context.stroke(); 
        
        // 盤面を見やすくするために点を四つ打つ
        var pt = [[2, 2], [6, 6], [2, 6], [6, 2]];
        for (var i = 0; i < pt.length; i++) {
            var x = pt[i][0] * cellW + padX;
            var y = pt[i][1] * cellW + padY;
            drawCircle(x, y, 4, "white");
        }

        var r2 = cellW / 2;
        
        drawCells(canvas, blacks, r2-2, 'black');
        drawCells(canvas, whites, r2-2, 'white');
        drawCells(canvas, suggests, 4, '#33cc33');
    }

    function drawCells (canvas, indexes, size, color) {
        
        var r2 = cellW / 2;

        console.log('color:', color);

        for (var i = 0, l = indexes.length; i < l; i++) {
            var col = indexes[i] % bCols;
            var row = Math.floor(indexes[i] / bCols);
            var x = padX + col * cellW;
            var y = padY + row * cellW;
            drawCircle(x+r2, y+r2, size, color);
        }
    } 

    function drawCircle(x, y, r, color) {
        context.beginPath();
        context.arc(x, y, r, 0, Math.PI * 2);
        context.fillStyle = color;
        context.fill();
    }

    function $(id) { return document.getElementById(id); }
    
</script>
</body>
</html>

